<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbox</title>
  </head>
  <body>
    Hello, world!
    <chat-box>
      Some stuff here
    </chat-box>

    <script>
      class ChatBox extends HTMLElement {
        constructor() {
          super()
          console.debug("initializing websocket connection.")
          this.socketConnection = new WebSocket("ws://localhost:9101/ws")
        }

        socketConnection

        initSocket() {
          return new Promise((resolve, reject) => {
            this.socketConnection.onopen = (ev) => {
              console.debug("websocket connected")
              resolve()
            }

            this.socketConnection.onerror = (ev) => {
              reject(ev)
            }
          })
        }

        async connectedCallback() {
          this.attachShadow({ mode: "closed" })
          await this.initSocket()
          console.debug("socket init done, send ping")
          this.socketConnection.send("ping")
        }
      }

      customElements.define("chat-box", ChatBox)
    </script>
  </body>
</html>
